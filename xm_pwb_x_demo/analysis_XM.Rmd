---
title: "baipishu"
author: "marshall ma"
date: "7/10/2020"
output:
  html_document: default
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r tools, include=FALSE}
#manipulation and cleaning
library(tidyr)
library(plyr)
library(stringr)
library(lubridate)
library(data.table)
library(dplyr)

#visualization
library(psych)
library(naniar)
library(arsenal)
library(ggcorrplot)
library(ggplot2)
```
```{r import, include=FALSE}
data <- read.csv("~/Documents/2020_2Summer/research/0Yale2009/data/output/bps_df0722_xm0727.csv", comment.char="#", encoding = "UTF-8")

head(data)
```



```{r transformation, include=FALSE}
data_vis <- data %>% 
  mutate(age_grp = ifelse(Age >= 25, "25+", "below25"), 
         gender_grp = ifelse(Gender == 1, "Male", 
                      ifelse(Gender == 2, "Female", 
                      ifelse(Gender < 667, "Non-binary", NA))), 
         degree_grp = ifelse(Degree == 1, "a.UnderGrad", 
                      ifelse(Degree == 2, "b.Master", 
                      ifelse(Degree == 3, "d.MBA", 
                      ifelse(Degree == 4, "c.PhD", NA)))),
         religion_grp = ifelse(Religion %in% c(1,2,3,4,5), "教", 
                      ifelse(Religion == 6, "无宗教信仰", NA)),
         gpa_grp = ifelse(GPA == 1, "a.3.8+", 
                      ifelse(GPA == 2, "b.3.5-3.8", 
                      ifelse(GPA == 3, "c.3.3-3.5", 
                      ifelse(GPA == 4, "d.3.0-3.3", 
                      ifelse(GPA == 5, "e.3-", NA))))),
         gpa_change_grp = ifelse(GradeChange == 1, "a明显变好", 
                      ifelse(GradeChange == 2, "b变好", 
                      ifelse(GradeChange == 3, "c不变", 
                      ifelse(GradeChange == 4, "d变差", 
                      ifelse(GradeChange == 5, "e明显变差", NA))))),
         sex_o_grp = ifelse(SexOrient == 1, "a异性恋", 
                      ifelse(SexOrient == 2, "b同性恋", 
                      ifelse(SexOrient == 3, "c双性恋", 
                      ifelse(SexOrient == 4, "d泛性恋", 
                      ifelse(SexOrient == 5, "e无性恋", "其他/不想回答"))))),
         visa_grp = ifelse(Visa == 1, "a绿卡", 
                      ifelse(Visa == 2, "b学生", 
                      ifelse(Visa == 3, "c工作转换", "其他/不想回答"))), 
         sib_grp = ifelse(Sibling == 0, "a独生子女", "b非独生"), 
         
         MEMS_3 = MEMS1 + MEMS2 + MEMS3,
         
         #sometime
         time_new = ymd_hms(TimeSubmit), time_day = as.Date(TimeSubmit),
         ICE = ifelse(time_new <= as.POSIXct("2020-07-06 05"), "beforeICE", 
               ifelse(time_new >= as.Date("2020-07-14 05"), "postICE", "duringICE"))
        ) 

data_vis_pwb <- data_vis %>%
  gather(PWB, PWB_val, PSS_sum:QLES_sum)

data_vis_lt <- data_vis %>%
  gather(Latent, Lt_val, c(ERQ_reap:MEMS, SSSI_avg))

data_vis_mhsat <- data_vis %>%
  gather(ServSat, Sat_val, c(ServSat1:ServSat9))



```

##Stage II: Overview    
      |  demo   |   MH exp |    
PWB   |   x     |     x    
Latent|   x     |     x    
Spec  |   x     |     x    
MH exp|   x     |    

Part 1. Demo  
- Summary stats of MH usage by Demo
- Need some finance info
```{r demo by service}

table_10 <- tableby(Service ~ age_grp + gender_grp + degree_grp + religion_grp + sex_o_grp + sib_grp + visa_grp + gpa_grp + gpa_change_grp, data = data_vis)

my_labels <- list(
  age_grp = "年龄分组",
  gender_grp = "性别分组",
  degree_grp = "学位分组",
  religion_grp = "宗教分组",
  sex_o_grp = "性取向分组",
  sib_grp = "独生子女分组",
  visa_grp = "身份分组",
  gpa_grp = "成绩分组",
  gpa_change_grp = "成绩变化分组"
)

summary(table_10, title = "demo By Service", labelTranslations = my_labels, text = TRUE)

```

Part 2. MH usage by PWB + Latent
```{r}

table_20 <- tableby(Service ~ PHQ_sum + GAD_sum + PSS_sum + SWLS_sum + QLES_sum + SCOFF_nervosa, data = data_vis)
summary(table_20, title = "PWB By Service", text = TRUE)


table_21 <- tableby(Service ~ ERQ_reap + ERQ_sup + GSE_sum + MEMS + SSSI_avg, data = data_vis)
summary(table_21, title = "Latent By Service", text = TRUE)


```


Part 3 PWB across groups
age_grp
gender_grp
degree_grp
religion_grp
sex_o_grp 
sib_grp
visa_grp
gpa_grp
gpa_change_grp

```{r}
#helper func


(plot30 <- ggplot(data_vis_pwb, aes(x = PWB, y = PWB_val, fill = age_grp)) + geom_bar(position = "dodge", stat = "summary", fun = mean) + scale_fill_brewer(palette="Set3"))


(plot31 <- ggplot(data_vis_pwb, aes(x = PWB, y = PWB_val, fill = gender_grp)) + geom_bar(position = "dodge", stat = "summary", fun = mean) + scale_fill_brewer(palette="Set3"))


(plot32 <- ggplot(data_vis_pwb, aes(x = PWB, y = PWB_val, fill = degree_grp)) + geom_bar(position = "dodge", stat = "summary", fun = mean) + scale_fill_brewer(palette="Set3"))


(plot33 <- ggplot(data_vis_pwb, aes(x = PWB, y = PWB_val, fill = religion_grp)) + geom_bar(position = "dodge", stat = "summary", fun = mean) + scale_fill_brewer(palette="Set3"))


(plot34 <- ggplot(data_vis_pwb, aes(x = PWB, y = PWB_val, fill = sex_o_grp)) + geom_bar(position = "dodge", stat = "summary", fun = mean) + scale_fill_brewer(palette="Set3"))


(plot35 <- ggplot(data_vis_pwb, aes(x = PWB, y = PWB_val, fill = sib_grp)) + geom_bar(position = "dodge", stat = "summary", fun = mean) + scale_fill_brewer(palette="Set3"))


(plot36 <- ggplot(data_vis_pwb, aes(x = PWB, y = PWB_val, fill = visa_grp)) + geom_bar(position = "dodge", stat = "summary", fun = mean) + scale_fill_brewer(palette="Set3"))


(plot37 <- ggplot(data_vis_pwb, aes(x = PWB, y = PWB_val, fill = gpa_grp)) + geom_bar(position = "dodge", stat = "summary", fun = mean) + scale_fill_brewer(palette="Set3"))


(plot38 <- ggplot(data_vis_pwb, aes(x = PWB, y = PWB_val, fill = gpa_change_grp)) + geom_bar(position = "dodge", stat = "summary", fun = mean) + scale_fill_brewer(palette="Set3"))

```

Part 4 fun
```{r}
ggplot(data_vis, aes(x = SocSup9, y = ERQ_sup)) + 
  geom_count() + 
  scale_size_area(max_size = 3) 

cor(data_vis$SocSup9, data_vis$ERQ_sup)


#  gather(ServSat, Sat_val, c(ServSat1:ServSat9))

(plot40 <- ggplot(data_vis_mhsat, aes(x = ServSat, y = Sat_val, fill = as.factor(Service))) + geom_bar(position = "dodge", stat = "summary", fun = mean) + scale_fill_brewer(palette="Set3"))

table_40 <- tableby(Service ~ ServSat1 + ServSat2 + ServSat3 + ServSat4 + ServSat5 + ServSat6 + ServSat7 + ServSat8 + ServSat9, data = data_vis)
summary(table_40, title = "Sat By Service", text = TRUE)


#health condition
data_vis_health <- data_vis %>% 
  mutate(health = ifelse((COVID1 == 1) | (COVID2 == 1) | (COVID3 == 1), "threatened", "okay"))

#summary(as.factor(data_vis$COVID1))

table_41 <- tableby(health ~ PHQ_sum + GAD_sum + PSS_sum + SWLS_sum + QLES_sum + SCOFF_nervosa, data = data_vis_health)
summary(table_41, title = "Sat By Service", text = TRUE)

```
